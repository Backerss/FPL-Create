<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FLIGHT CREATE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="css/custom.css">

    <!-- ... existing head content ... -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <!-- ... existing head content ... -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.2/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.2/dist/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
</head>

<body class="bg-dark">

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-6 mx-auto">
                <div class="card mt-3 bg-dark text-white">
                    <div class="card-header bg-dark text-white">
                        <h2>FLIGHT CREATE</h2>
                    </div>
                    <div class="card-body">
                        <form id="flightForm">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="callsign" class="form-label">Callsign</label>
                                    <input type="text" class="form-control" id="callsign" placeholder="Ex. THA1"
                                        required>
                                </div>
                                <div class="col-md-4">
                                    <label for="atype" class="form-label">Aircraft Type</label>
                                    <select class="form-select" id="atype" required>
                                        <option value="" disabled selected>Select</option>
                                        <option value="A225">A225</option>
                                        <option value="CONC">CONC</option>
                                        <option value="A310">A310</option>
                                        <option value="A319">A319</option>
                                        <option value="A320">A320</option>
                                        <option value="A321">A321</option>
                                        <option value="A332">A332</option>
                                        <option value="A333">A333</option>
                                        <option value="A343">A343</option>
                                        <option value="A346">A346</option>
                                        <option value="A359">A359</option>
                                        <option value="A388">A388</option>
                                        <option value="AT75">AT75</option>
                                        <option value="B733">B733</option>
                                        <option value="B736">B736</option>
                                        <option value="B738">B738</option>
                                        <option value="B739">B739</option>
                                        <option value="B744">B744</option>
                                        <option value="B747">B747</option>
                                        <option value="B748">B748</option>
                                        <option value="B752">B752</option>
                                        <option value="B767">B767</option>
                                        <option value="B772">B772</option>
                                        <option value="B773">B773</option>
                                        <option value="B77W">B77W</option>
                                        <option value="B788">B788</option>
                                        <option value="B789">B789</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="departure" class="form-label">Departure</label>
                                    <input type="text" class="form-control" id="departure" placeholder="Ex. ZZZZ"
                                        maxlength="4" list="airportList" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="arrival" class="form-label">Arrival</label>
                                    <input type="text" class="form-control" id="arrival" placeholder="Ex. ZZZZ"
                                        maxlength="4" list="airportList" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="initialLevel" class="form-label">Initial Flight Level</label>
                                    <input type="number" class="form-control" id="initialLevel"
                                        placeholder="Ex. 10,20,30,40" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="requestLevel" class="form-label">Requested Flight Level</label>
                                    <input type="number" class="form-control" id="requestLevel"
                                        placeholder="Ex. 10, 20, 30, 40" required>
                                </div>
                            </div>

                            <datalist id="airportList">
                                <!-- Options will be populated dynamically via JavaScript -->
                            </datalist>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="clearedLevel" class="form-label">Cleared Flight Level</label>
                                    <input type="number" class="form-control" id="clearedLevel"
                                        placeholder="Ex. 10, 20, 30, 40" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="squawk" class="form-label">Squawk</label>
                                    <input type="text" class="form-control" id="squawk" placeholder="Ex. 1234" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="spawntime" class="form-label">Spawn Time (Seconds)</label>
                                    <input type="number" class="form-control" id="spawntime" placeholder="Ex. 3600"
                                        required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label for="route" class="form-label">Route</label>
                                    <textarea class="form-control" id="route" rows="3" placeholder="Ex. DCT"
                                        required></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-5 mb-5">
            <div class="col-lg-10 mx-auto">
                <div class="card bg-dark">
                    <div class="card-body">
                        <h5 class="card-title">Flight Table</h5>
                        <button id="copyButton" class="btn btn-secondary mb-3">Copy Table</button>
                        <button id="exportButton" class="btn btn-success mb-3">Export as CSV</button>
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th scope="col">Callsign</th>
                                    <th scope="col">Aircraft Type</th>
                                    <th scope="col">Departure</th>
                                    <th scope="col">Arrival</th>
                                    <th scope="col">Initial Flight Level</th>
                                    <th scope="col">Requested Flight Level</th>
                                    <th scope="col">Cleared Flight Level</th>
                                    <th scope="col">Squawk</th>
                                    <th scope="col">Spawn Time</th>
                                    <th scope="col">Special</th>
                                    <th scope="col">Special Time</th>
                                    <th scope="col">Route</th>
                                    <th scope="col">Final Level</th>
                                    <th scope="col">Reaching Level</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows will be added here dynamically -->
                                <tr id="noDataRow">
                                    <td colspan="14" class="text-center">Nodata</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>


    <script>

        let airlinesData = {};

        // โหลดข้อมูล airlines.json
        async function loadAirlinesData() {
            try {
                const response = await fetch('data/airlines.json');
                if (!response.ok) throw new Error('Network response was not ok');
                airlinesData = await response.json();
            } catch (error) {
                console.error('Error loading airlines data:', error);
            }
        }

        // แปลง callsign เป็น ICAO code โดยดึงตัวอักษรสองตัวแรก
        function getICAOCodeFromCallsign(callsign) {
            const prefix = callsign.slice(0, 2); // ดึงตัวอักษรสองตัวแรก
            for (const airline of Object.values(airlinesData)) {
                if (airline.iata === prefix) {
                    return `${airline.icao}${callsign.slice(2)}`; // รวม ICAO code กับตัวเลข
                }
            }
            return ''; // คืนค่าว่างถ้าไม่พบ
        }

        // โหลดข้อมูลเมื่อหน้าเว็บโหลด
        loadAirlinesData();


    </script>




    <script>
        let validAirports = new Set();

        async function loadValidAirports() {
            try {
                const response = await fetch('data/airport.json');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                validAirports = new Set(Object.values(data).map(airport => airport.icao.toUpperCase()));
                populateAirportList();
            } catch (error) {
                console.error('Error loading ICAO codes:', error);
                validAirports = new Set(); // Fallback to an empty set on error
            }
        }

        function populateAirportList() {
            const airportList = document.getElementById('airportList');
            airportList.innerHTML = ''; // Clear existing list

            validAirports.forEach(icao => {
                const option = document.createElement('option');
                option.value = icao;
                airportList.appendChild(option);
            });
        }

        // Call this function once to preload the ICAO codes
        loadValidAirports();





    </script>

    <script>
        document.getElementById('flightForm').addEventListener('submit', function (event) {
            event.preventDefault(); // ป้องกันการรีเฟรชหน้าเว็บ

            const callsignInput = document.getElementById('callsign').value.trim();
            const atypeInput = document.getElementById('atype').value.trim();
            const departureInput = document.getElementById('departure').value.trim();
            const arrivalInput = document.getElementById('arrival').value.trim();
            const initialLevelInput = document.getElementById('initialLevel').value.trim();
            const requestLevelInput = document.getElementById('requestLevel').value.trim();
            const clearedLevelInput = document.getElementById('clearedLevel').value.trim();
            const squawkInput = document.getElementById('squawk').value.trim();
            const spawntimeInput = document.getElementById('spawntime').value.trim();
            const routeInput = document.getElementById('route').value.trim();

            // แปลง callsign เป็น ICAO code
            const icaoCode = getICAOCodeFromCallsign(callsignInput);

            if (icaoCode) {
                // ค้นหาตารางใน HTML
                const tableBody = document.querySelector('table tbody');

                // สร้างแถวใหม่
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
            <td>${icaoCode}</td>
            <td>${atypeInput}</td>
            <td>${departureInput}</td>
            <td>${arrivalInput}</td>
            <td>F${initialLevelInput}</td>
            <td>F${requestLevelInput}</td>
            <td>F${clearedLevelInput}</td>
            <td>${squawkInput}</td>
            <td>${spawntimeInput}</td>
            <td>0</td> <!-- Special -->
            <td>0</td> <!-- Special Time -->
            <td>${routeInput}</td>
            <td>F${requestLevelInput}</td> <!-- Final Level -->
            <td>LVL</td> <!-- Reaching Level -->
        `;

                // เพิ่มแถวใหม่ลงในตาราง
                tableBody.appendChild(newRow);

                // ซ่อนแถว "Nodata"
                const noDataRow = document.getElementById('noDataRow');
                if (noDataRow) {
                    noDataRow.style.display = 'none';
                }

                // ตัวอย่างการใช้ SweetAlert
                Swal.fire({
                    title: 'Submitted!',
                    text: `ICAO Code: ${icaoCode}`,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: 'Invalid callsign',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });

    </script>

    <script>
        document.getElementById('squawk').addEventListener('focus', function () {
            if (!this.value) {
                // Generate a 4-digit number with digits only from 0 to 7
                this.value = Array.from({ length: 4 }, () => Math.floor(Math.random() * 8)).join('');
            }
        });

        async function loadValidRoutes() {
            try {
                const response = await fetch('data/fix_name.txt');
                if (!response.ok) throw new Error('Network response was not ok');
                const text = await response.text();
                const routes = text.split('\n').map(route => route.trim().toUpperCase()).filter(route => route);
                return new Set(routes);
            } catch (error) {
                return new Set(); // Return empty set on error
            }
        }

        document.getElementById('copyButton').addEventListener('click', function () {
            const table = document.querySelector('.table');
            const range = document.createRange();
            range.selectNode(table);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);

            try {
                document.execCommand('copy');
                Swal.fire({
                    icon: 'success',
                    title: 'Copied',
                    text: 'Table data has been copied to clipboard.',
                });
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Copy Failed',
                    text: 'Failed to copy table data.',
                });
            }

            window.getSelection().removeAllRanges(); // Deselect the text
        });
    </script>

    <script>
        document.getElementById('exportButton').addEventListener('click', function () {
            const table = document.querySelector('.table');
            let csvContent = "data:text/csv;charset=utf-8,";

            // Get table headers
            const headers = Array.from(table.querySelectorAll('thead th'))
                .map(th => th.textContent)
                .join(',');

            csvContent += headers + '\n';

            // Get table rows
            const rows = Array.from(table.querySelectorAll('tbody tr'))
                .map(tr => Array.from(tr.querySelectorAll('td'))
                    .map(td => td.textContent)
                    .join(','))
                .join('\n');

            csvContent += rows;

            // Create a link element and set its href to the CSV content
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'flight_data.csv');

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

    </script>

</body>

</html>